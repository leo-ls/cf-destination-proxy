trigger:
  - main

pool:
  vmImage: "ubuntu-latest"

steps:
  - checkout: self
    clean: true
    persistCredentials: true

  - task: NodeTool@0
    displayName: "Install Node.js"
    inputs:
      versionSpec: "12.x"

  - task: npmAuthenticate@0
    displayName: "Authenticate NPM connection"
    inputs:
      customEndpoint: npmjs.com_leo-ls

  - bash: |
      echo ">>> Configure Git"
      git config --global user.name $(GIT_COMMITTER_NAME)
      git config --global user.email $(GIT_COMMITTER_EMAIL)
      git checkout main --progress --force
      echo ">>> Build"
      npm install --no-package-lock
      npm run release
      npm run build
      echo ">>> Push results"
      git push --follow-tags origin main
    displayName: "Build"
    condition: succeeded()
    env:
      GIT_COMMITTER_NAME: $(GIT_COMMITTER_NAME)
      GIT_COMMITTER_EMAIL: $(GIT_COMMITTER_EMAIL)

  - task: Npm@1
    displayName: "Publish NPM package"
    inputs:
      command: publish
      publishEndpoint: npmjs.com_leo-ls

  - task: CopyFiles@2
    displayName: "Copy .mtar to staging directory"
    inputs:
      contents: "mta_archives/**"
      targetFolder: $(Build.ArtifactStagingDirectory)

  - task: GitHubRelease@0
    displayName: "Create GitHub release"
    inputs:
      gitHubConnection: github.com_leo-ls
      repositoryName: leo-ls/cf-destination-proxy
      action: create
      isDraft: false
